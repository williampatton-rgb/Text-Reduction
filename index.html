<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Article Simplifier for Students</title>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/mammoth/1.6.0/mammoth.browser.min.js"></script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f4f4f9;
            color: #333;
            max-width: 800px;
            margin: 0 auto;
            padding: 20px;
        }
        h1 {
            text-align: center;
            color: #2c3e50;
        }
        .container {
            background: #fff;
            padding: 20px 30px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        .form-group {
            margin-bottom: 20px;
        }
        label {
            display: block;
            font-weight: bold;
            margin-bottom: 5px;
        }
        input[type="text"], input[type="password"], textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-family: inherit;
        }
        textarea {
            resize: vertical;
            height: 150px;
        }
        /* Upgraded output box to support rich text (bolding) */
        .output-box {
            width: 100%;
            padding: 10px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-family: inherit;
            min-height: 150px;
            background-color: #fcfcfc;
            overflow-y: auto;
        }
        .output-box:empty:before {
            content: attr(data-placeholder);
            color: #999;
            pointer-events: none;
            display: block; /* For Firefox */
        }
        .api-container {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .api-container input[type="password"], .api-container input[type="text"] {
            flex-grow: 1;
        }
        .file-upload-container {
            background-color: #ecf0f1;
            border: 2px dashed #bdc3c7;
            padding: 15px;
            text-align: center;
            border-radius: 4px;
            margin-bottom: 15px;
        }
        input[type="file"] {
            display: none;
        }
        .file-label {
            background-color: #95a5a6;
            color: white;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
            display: inline-block;
            font-weight: normal;
            transition: background 0.3s;
        }
        .file-label:hover {
            background-color: #7f8c8d;
        }
        button {
            background-color: #3498db;
            color: white;
            border: none;
            padding: 10px 20px;
            font-size: 16px;
            border-radius: 4px;
            cursor: pointer;
            transition: background 0.3s;
        }
        button:hover {
            background-color: #2980b9;
        }
        button:disabled {
            background-color: #95a5a6;
            cursor: not-allowed;
        }
        .actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
            flex-wrap: wrap;
        }
        .btn-secondary {
            background-color: #2ecc71;
        }
        .btn-secondary:hover {
            background-color: #27ae60;
        }
        .btn-danger {
            background-color: #e74c3c;
            margin-left: auto;
        }
        .btn-danger:hover {
            background-color: #c0392b;
        }
        .status {
            margin-top: 10px;
            font-style: italic;
            color: #7f8c8d;
        }
        .error-text {
            color: #e74c3c;
            font-weight: bold;
        }
        .char-count {
            font-size: 0.85em;
            color: #7f8c8d;
            text-align: right;
            margin-top: 5px;
        }
    </style>
</head>
<body>

    <h1>Article Simplifier <br><span style="font-size: 0.6em; color: #7f8c8d;">Powered by Gemini 2.5 Flash</span></h1>
    
    <div class="container">
        <div class="form-group">
            <label for="apiKey">Gemini API Key:</label>
            <div class="api-container">
                <input type="password" id="apiKey" placeholder="AIzaSy..." onchange="saveApiKey()">
                <label style="font-weight: normal; margin: 0; display: flex; align-items: center; gap: 5px;">
                    <input type="checkbox" id="toggleKey" onclick="toggleApiKeyVisibility()"> Show
                </label>
            </div>
            <div style="font-size: 0.8em; color: #7f8c8d; margin-top: 5px;">Your key is saved locally in your browser.</div>
        </div>

        <div class="form-group">
            <label>Provide Article Content:</label>
            <div class="file-upload-container">
                <span id="fileStatus" style="display: block; margin-bottom: 10px; font-size: 0.9em; color: #34495e;">Upload a .docx or .pdf file to automatically extract the text.</span>
                <label for="fileInput" class="file-label">Choose File</label>
                <input type="file" id="fileInput" accept=".pdf,.docx" onchange="handleFileUpload(event)">
            </div>
            <textarea id="inputText" placeholder="Paste the text you want to simplify, or upload a file above..." oninput="updateCharCount()"></textarea>
            <div id="charCount" class="char-count">0 / 100,000 characters</div>
        </div>

        <button id="simplifyBtn" onclick="processText()">Simplify Article</button>
        <div id="statusText" class="status"></div>

        <div class="form-group" style="margin-top: 30px;">
            <label for="outputText">Simplified Result:</label>
            <div id="outputText" class="output-box" contenteditable="true" data-placeholder="Your formatted bullet points will appear here..."></div>
        </div>

        <div class="actions">
            <button class="btn-secondary" id="copyBtn" onclick="copyText()" disabled>Copy Text</button>
            <button class="btn-secondary" id="downloadBtn" onclick="downloadWord()" disabled>Download as Word (.doc)</button>
            <button class="btn-danger" id="clearBtn" onclick="clearAll()">Clear All</button>
        </div>
    </div>

    <script>
        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

        // Updated Prompt to enforce grouping under Bold Headers
        const systemPrompt = `Please simplify this article into Bullet Points. Group the bullet points logically under short, descriptive Bold Headers (using markdown formatting like **Header**). Do not add pictures. Do not add any text other than the headers and bullet points. Do not add any additional information. Do not delete any information. Only simplify and shorten the language. Make it as short and simple as you can while retaining all essential facts. Simplify it so that a 5th grade non-native speaker could understand it.`;
        const MAX_CHARS = 100000;

        window.onload = function() {
            const savedKey = localStorage.getItem("geminiApiKey");
            if (savedKey) {
                document.getElementById("apiKey").value = savedKey;
            }
        };

        function saveApiKey() {
            const apiKey = document.getElementById("apiKey").value.trim();
            if (apiKey) localStorage.setItem("geminiApiKey", apiKey);
            else localStorage.removeItem("geminiApiKey");
        }

        function toggleApiKeyVisibility() {
            const apiKeyInput = document.getElementById("apiKey");
            apiKeyInput.type = apiKeyInput.type === "password" ? "text" : "password";
        }

        function updateCharCount() {
            const inputText = document.getElementById("inputText").value;
            const countDisplay = document.getElementById("charCount");
            countDisplay.innerText = `${inputText.length.toLocaleString()} / ${MAX_CHARS.toLocaleString()} characters`;
            countDisplay.style.color = inputText.length > MAX_CHARS ? "#e74c3c" : "#7f8c8d";
        }

        async function handleFileUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            const fileStatus = document.getElementById('fileStatus');
            const inputText = document.getElementById('inputText');
            
            fileStatus.innerText = `Extracting text from ${file.name}... Please wait.`;
            fileStatus.style.color = "#2980b9";

            try {
                const arrayBuffer = await file.arrayBuffer();
                let extractedText = "";

                if (file.name.toLowerCase().endsWith('.docx')) {
                    const result = await mammoth.extractRawText({ arrayBuffer: arrayBuffer });
                    extractedText = result.value;
                } 
                else if (file.name.toLowerCase().endsWith('.pdf')) {
                    const pdf = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    for (let i = 1; i <= pdf.numPages; i++) {
                        const page = await pdf.getPage(i);
                        const textContent = await page.getTextContent();
                        const pageText = textContent.items.map(item => item.str).join(' ');
                        extractedText += pageText + '\n\n';
                    }
                } else {
                    throw new Error("Unsupported file type.");
                }

                if (!extractedText.trim()) throw new Error("Could not find any readable text in this document.");

                if (inputText.value.trim() !== "") inputText.value += "\n\n" + extractedText;
                else inputText.value = extractedText;

                updateCharCount();
                fileStatus.innerText = `Success! Text extracted from ${file.name}.`;
                fileStatus.style.color = "#27ae60";

            } catch (error) {
                console.error(error);
                fileStatus.innerText = `Error extracting text: ${error.message}`;
                fileStatus.style.color = "#e74c3c";
            }
            event.target.value = ''; 
        }

        async function processText() {
            const apiKey = document.getElementById("apiKey").value.trim();
            const inputText = document.getElementById("inputText").value.trim();
            const statusText = document.getElementById("statusText");
            const simplifyBtn = document.getElementById("simplifyBtn");

            if (!apiKey) return alert("Please enter your Gemini API Key.");
            if (!inputText) return alert("Please paste an article or upload a file.");
            if (inputText.length > MAX_CHARS) return alert(`This article is too long! Please trim it to under ${MAX_CHARS.toLocaleString()} characters.`);

            saveApiKey();

            statusText.className = "status"; 
            statusText.innerText = "Processing... this may take a few seconds.";
            simplifyBtn.disabled = true;

            try {
                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=${apiKey}`;
                const requestBody = {
                    system_instruction: { parts: [{ text: systemPrompt }] },
                    contents: [{ parts: [{ text: `Here is the article:\n\n${inputText}` }] }],
                    generationConfig: { temperature: 0.3 }
                };

                const response = await fetch(url, {
                    method: "POST",
                    headers: { "Content-Type": "application/json" },
                    body: JSON.stringify(requestBody)
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    let errorMessage = errorData.error?.message || response.statusText;
                    if (response.status === 400) errorMessage = "Bad Request: The text might be too complex.";
                    if (response.status === 401 || response.status === 403) errorMessage = "Invalid API Key.";
                    if (response.status === 429) errorMessage = "Too many requests! You hit your API limit.";
                    if (response.status === 500) errorMessage = "Gemini's servers are down.";
                    throw new Error(errorMessage);
                }

                const data = await response.json();
                if (!data.candidates || data.candidates.length === 0 || !data.candidates[0].content) {
                    throw new Error("Gemini refused to process this text. It may have triggered a safety filter.");
                }

                let rawOutput = data.candidates[0].content.parts[0].text;
                
                // NEW FORMATTING LOGIC:
                // Converts AI's **Markdown** into HTML <strong> tags
                // Wraps each line in a <p> tag with a 12pt bottom margin to strictly enforce the "1 blank line" rule
                const formattedOutput = rawOutput
                    .split('\n')
                    .map(line => line.trim())
                    .filter(line => line.length > 0)
                    .map(line => {
                        let htmlLine = line.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
                        return `<p style="margin-bottom: 12pt; margin-top: 0;">${htmlLine}</p>`;
                    })
                    .join('');

                // Inject the rich text into our new div
                document.getElementById("outputText").innerHTML = formattedOutput;
                statusText.innerText = "Done!";
                
                document.getElementById("copyBtn").disabled = false;
                document.getElementById("downloadBtn").disabled = false;

            } catch (error) {
                console.error(error);
                statusText.className = "status error-text";
                statusText.innerText = "Error: " + error.message;
            } finally {
                simplifyBtn.disabled = false;
            }
        }

        function copyText() {
            // Updated copy logic to preserve the formatting (bolding/spacing) when pasting to Word/Google Docs
            const outputBox = document.getElementById("outputText");
            const range = document.createRange();
            range.selectNodeContents(outputBox);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);

            try {
                document.execCommand('copy');
                alert("Copied to clipboard with formatting!");
            } catch (err) {
                alert("Failed to copy text: " + err);
            }
            selection.removeAllRanges(); // Deselect text after copying
        }

        function downloadWord() {
            // Grabs the pre-formatted HTML (with strong tags) directly from the div
            const htmlContent = document.getElementById("outputText").innerHTML;
            
            const header = "<html xmlns:o='urn:schemas-microsoft-com:office:office' xmlns:w='urn:schemas-microsoft-com:office:word' xmlns='http://www.w3.org/TR/REC-html40'><head><meta charset='utf-8'><title>Simplified Article</title></head><body>";
            const footer = "</body></html>";
            
            const blob = new Blob(['\ufeff', header + htmlContent + footer], { type: 'application/msword' });
            
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'Simplified_Article.doc'; 
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function clearAll() {
            if (confirm("Are you sure you want to clear the text areas?")) {
                document.getElementById("inputText").value = "";
                document.getElementById("outputText").innerHTML = ""; // Clears the div
                document.getElementById("statusText").innerText = "";
                document.getElementById("fileStatus").innerText = "Upload a .docx or .pdf file to automatically extract the text.";
                document.getElementById("fileStatus").style.color = "#34495e";
                document.getElementById("copyBtn").disabled = true;
                document.getElementById("downloadBtn").disabled = true;
                updateCharCount();
            }
        }
    </script>
</body>
</html>
